# 2026-02-03 Worklog - BaseCancel/Close Debug

## Goals
- [x] 排撤：外部单出现后能触发撤第二单
- [x] buy list：支持 `2026-02-02_list.csv` 等命名并打印实际读取文件
- [x] 收盘：将“不在名单的持仓”全部清仓（包含 Close 留下的 300 股）
- [x] Close：70% 限制基于 14:53 窗口启动时的可用持仓

## Change Summary

- `result/src/adapters/SecTradingApi.cpp`
  - OnStructMsgCallback 路由：不再只依赖 `nStructToken`，增加 account/实例兜底，避免外部单被丢弃
  - notify type 采用 ITPDK 标准值（来自 `itpdk_dict.h`）
- `result/src/modules/BaseCancelModule.cpp`
  - 触发排撤：只使用 `NOTIFY_PUSH_ORDER`（nType=8）
  - buy list：按目录下 CSV 修改时间选最新（优先 `_list`）
  - 新增 `do_sell_non_list_positions`：14:59:50-14:59:57 清仓不在名单中的持仓（跌停价）
- `result/src/modules/Qh2hSellModule.cpp`
  - 成交推送过滤：`NOTIFY_PUSH_MATCH`（nType=10）
- `result/src/strategies/CloseSellStrategy.cpp/.h`
  - Phase1：记录 14:53 窗口首次进入时的 `Position.available` 作为 70% 限制基数
  - 补齐缺失头文件 `<unordered_map>`
- `result/main.cpp`
  - buy list 订阅合并：按修改时间选最新（优先 `_list`），避免启动订阅遗漏

## Key Assumptions
- 交易回调的 nType 定义以 `result/include_external/windows/itpdk/itpdk_dict.h` 为准（8=委托推送，10=成交推送）。
- Close 的 Phase4 在 14:59:50 前结束；BaseCancel 在 14:59:50-14:59:57 补充清仓。

## Verification
- Windows：`cmake --build .\\result\\build --config Release` 通过。

## Next
- [ ] 如需更严格的“14:53:00 基数”，保证进程在 14:53 前启动或增加对齐逻辑
- [ ] 为 BaseCancel/Close 增加最小化回放/离线测试样例（防止回归）


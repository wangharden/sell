# 交易侧改造施工设计稿：从 TDF 直连迁移到 md_gateway SHM（多进程多实例）

> 项目背景：同一台机器会运行多个 `trade_app`（多个交易程序实例），但**行情只允许一个进程登录 TDF**。  
> 现状：`D:\work\sell3\result` 的交易程序仍在直连 TDF（`TdfMarketDataApi`）。  
> 目标：交易侧只连接交易柜台（`SecTradingApi`/`QueuedTradingApi`），行情改为读取 `md_gateway` 写入的共享内存快照表（SeqLock）。

参考（已完成）：`gate_result/review/review_report_v2.md`（gateway/IPC 二稿审查通过点与约束）。  

---

## 1. 目标与非目标

### 1.1 目标

- trade 侧 **不再登录 TDF**，也不生成/维护 TDF 订阅
- trade 侧通过 **共享内存（SHM）只读**获取最新快照（每 symbol 一条快照）
- 支持同机 **多个 trade_app 并发读取同一块 SHM**
- 对现有策略/模块代码改动最小：维持 `IMarketDataApi` / `TradingMarketApi` 的调用形态
- 明确故障语义：`md_gateway` 掉线/重启时 trade 的降级策略（禁交易/仅撤单等）

### 1.2 非目标（本阶段不做）

- 不做 event ring（逐笔/委托/成交事件流），只做快照表
- 不做交易侧性能极限优化（忙轮询/绑核/hugepage）；先保证正确性与工程落地
- 不在本阶段重构策略逻辑（Auction/Intraday/Close 等）

---

## 2. 现状梳理（result 侧当前结构）

### 2.1 关键路径

- `result/main.cpp`
  - 合并多个模块/持仓生成 `./data/subscribe_all.csv`
  - `std::make_shared<TdfMarketDataApi>()` + `market->connect(...)`
  - `ctx.market = market;` 供模块/策略使用

- `result/src/adapters/TdfMarketDataApi.*`
  - TDF 回调写 `snapshot_cache_` / `tick_cache_`（带 mutex）

- `result/src/core/IMarketDataApi.h`
  - 策略侧依赖的接口：`get_snapshot/get_limits/get_auction_data` 等

### 2.2 策略/模块对行情的真实依赖

- 主要使用：
  - `get_snapshot(symbol)`：盘口、最新价、昨收、成交额等
  - `get_limits(symbol)`：涨跌停（来自 snapshot）
  - `get_auction_data(symbol,date,end_time)`：当前实现也只是用 snapshot 的 `open/turnover` 并按时间裁剪
- `get_history_ticks()` 当前就是空实现（warning），基本可忽略

结论：用 SHM 快照表替换 TDF 缓存，对策略影响可控。

---

## 3. 目标架构（trade 侧）

```
  +------------------+       read-only mmap        +---------------------+
  | trade_app (N个)  | <-------------------------- | md_gateway (唯一)   |
  | - SecTradingApi  |   SHM: Header + entries[]   | - login TDF         |
  | - ShmMarketData  |   SeqLock per entry         | - write snapshot    |
  +------------------+                             +---------------------+
```

trade_app 的“行情连接”变为：

- 打开命名 SHM（只读）
- 校验 header（magic/version/bytes）
- 读取 entries[symbol_id]（SeqLock），解码为 `MarketSnapshot`

---

## 4. 与 gateway 的 IPC 约定（trade 侧必须遵守）

### 4.1 SHM ABI 与 payload

以 gateway 二稿为准（`gate_result/struct_def.h` + `gate_result/marketdata_payload.h`）：

- `ShmHeader.magic = "MDGATE1"`
- `ShmHeader.abi_version = 1`
- `symbol_count = 3000`
- `SnapshotEntry`：
  - `seq`：odd/even seqlock
  - `payload`：320B 固定大小
- payload 版本：`MarketDataPayloadV1`（320B）
  - 价格为 `x10000` 整数；trade 解码时除以 10000.0
  - `flags bit0=valid`
  - `time_hhmmssmmm` 直接可映射到 `MarketSnapshot.timestamp`
  - `turnover` 为 `int64`（当前策略把它 cast 为 double 使用）

### 4.2 健康检查字段

trade 侧至少使用：

- `header.heartbeat_ns`：gateway 存活心跳（单调时钟 ns）
- `header.md_status`：0=OK，非 0 表示断线/重连中
- `header.last_md_ns`：最近一次收到行情的时间（单调 ns）
- `header.writer_start_ns`：epoch；变化表示 gateway 重启

---

## 5. 交易侧改造范围（文件/模块级别）

> 目标是“替换行情来源”，保持交易与策略架构不变。

### 5.1 新增：ShmMarketDataApi（实现 IMarketDataApi）

建议新增：`result/src/adapters/ShmMarketDataApi.h/.cpp`（本阶段仅设计，不要求实现）。

职责：

- `connect(...)`：打开 shm + 校验 header + 初始化映射/健康状态
- `is_connected()`：shm 已打开且 header 通过校验（且可选：heartbeat 未超时）
- `get_snapshot(symbol)`：symbol → symbol_id → SeqLock 读 entry → decode 成 `MarketSnapshot`
- `get_limits(symbol)`：从 snapshot 的 `high_limit/low_limit` 返回
- `get_auction_data(symbol,date,end_time)`：
  - 语义保持与现有 `TdfMarketDataApi` 一致：用 snapshot 的 `open` 与 `turnover`
  - 若 snapshot 时间 > end_time，则返回 `{open, 0}` 或 `{0,0}`（沿用当前实现）
- `disconnect()`：关闭 shm 映射
- `get_history_ticks()`：继续返回空（与现有行为一致）

> 关键点：trade 侧不需要任何 TDF 头文件/库。

### 5.2 必须解决：symbol → symbol_id 映射（避免映射不一致）

现状：gateway 二稿 **未写 symbol_dir**（`symbol_dir_offset=0`），且 payload 的 `wind_code` 只有在收到该 symbol 行情后才会被写入。

因此 trade 侧映射建议（按优先级）：

1. **配置驱动映射（推荐，确定性强）**  
   在 trade 的 config 中增加 `market_shm.symbol_csv_path`，指向 **与 gateway 完全相同** 的订阅 CSV（顺序即 symbol_id）。  
   trade 启动时解析 CSV，构建 `symbol(string) -> symbol_id`。

2. **兜底：扫描 entries 的 wind_code（非确定性，有延迟）**  
   若未配置 CSV，则在首次调用 `get_snapshot(symbol)` 时尝试扫描 `entries[*].payload.wind_code` 做匹配并缓存结果。  
   缺点：该 symbol 未收到行情前 wind_code 为空，会导致短期无法映射。

> 结论：为了“盘前 init 就能拿到涨跌停/昨收”等字段，必须上 **方案 1**（CSV 映射），否则策略启动阶段不稳定。

### 5.3 main.cpp 改造点（流程与配置）

trade 侧 `result/main.cpp` 需要做以下结构改造（本阶段写清改法即可）：

- 删除/禁用“合并订阅并写 `./data/subscribe_all.csv`”逻辑  
  该职责迁移到 gateway 或部署流程；trade 不再对订阅列表做任何决策。

- 行情 API 实例替换：
  - `TdfMarketDataApi` → `ShmMarketDataApi`
  - `connect_market()` 的参数来自 `market_shm` 配置（shm_name / csv_path 等）

### 5.4 CMake / 依赖收口（让 trade 不再依赖 TDF）

目标：trade_app 编译/运行不需要 TDF 库（`TDFAPI30`）。

改造建议（写入施工清单，具体实现后续再做）：

- 从 `RUNNER_SOURCES` 中移除 `src/adapters/TdfMarketDataApi.cpp`
- 新增 `src/adapters/ShmMarketDataApi.cpp`
- `target_link_libraries(main ...)` 中移除 `TDFAPI30`（Linux/Windows 都如此）

> 注意：如果其它文件仍 `#include <TDF...>` 则需一并清理引用；本项目目标是“交易侧不碰 TDF”。

---

## 6. 配置改造（trade 侧 config.json）

### 6.1 建议新增配置段

在 `result/config.json` 新增（或替换原 `market` 段）：

```json
{
  "market_shm": {
    "shm_name": "/md_gate_shm",
    "symbol_csv_path": "./data/subscribe_all.csv",
    "heartbeat_timeout_ms": 1000,
    "open_retry_ms": 200,
    "require_md_status_ok": 1
  }
}
```

字段含义：

- `shm_name`：必须与 gateway 一致
- `symbol_csv_path`：与 gateway 使用的订阅 CSV 完全一致（用于 symbol_id 映射）
- `heartbeat_timeout_ms`：心跳超时阈值；超时进入降级
- `open_retry_ms`：trade 启动时找不到 shm 的重试间隔
- `require_md_status_ok`：若为 1，`md_status!=0` 直接视为行情不可用（禁止下单）

### 6.2 启动依赖

- gateway 必须先启动并创建 shm
- trade 启动时若 shm 不存在：
  - 方案 A：等待直到出现（推荐，易运维）
  - 方案 B：直接退出并由 supervisor 拉起

需要在设计中明确选择其一（建议 A + 超时退出）。

---

## 7. 运行时故障语义（trade 侧必须落地）

### 7.1 heartbeat 超时（gateway 可能挂了/卡住）

trade 行为（建议默认）：

- 标记行情不可用（MarketDataUnavailable）
- 禁止产生新订单（place_order 直接拒绝或策略层跳过）
- 允许撤单/风控平仓（可配置）
- 周期重试：若 heartbeat 恢复且 `md_status==OK`，再恢复策略

### 7.2 gateway 重启（epoch 变化）

判定：

- `header.writer_start_ns` 变化

trade 行为：

- 重新 open/mmap shm（或至少重做 header 校验）
- 清空 `symbol->id` 缓存并重建（从 `symbol_csv_path` 重新加载）
- 策略进入“等待行情恢复”状态后再继续

### 7.3 md_status != OK（TDF 断线/重连）

trade 行为建议：

- 若 `require_md_status_ok=1`：禁交易
- 否则：允许策略读取，但所有 snapshot 标记 `valid=false`（由策略自行处理）

---

## 8. 施工步骤（按“并行设计稿”风格的落地步骤）

### Step 0：确认约束（必须先定）

- gateway 的 shm 名称、symbol_count=3000、payload 版本 V1 是否固定
- 订阅 CSV 的“权威路径”与发布方式（gateway/部署产物）
- trade 的启动策略：等 shm 还是直接退出
- 故障降级策略：禁交易/仅撤单/仅平仓（由业务确认）

### Step 1：引入 SHM reader 依赖（仅框架）

两种方式任选其一（推荐 A）：

- A) 将 `gate_result` 的 reader 代码抽为可复用模块（推荐）  
  trade 侧只依赖 `shm_reader` + `struct_def` + `marketdata_payload`（不依赖 writer）。

- B) 在 `result` 内部复制一份 reader（简单但会产生双份维护成本）  

验收点：

- trade 侧工程可在不链接 TDF 的情况下编译通过（实现阶段再验证）

### Step 2：新增 `ShmMarketDataApi`（接口对齐现有策略）

接口清单（必须实现的行为语义，非代码）：

- `connect`：open shm + header 校验 + 读 `writer_start_ns`
- `is_connected`：shm 打开且通过校验；可选叠加 heartbeat 判定
- `get_snapshot`：symbol→id→SeqLock 读→decode
- `get_limits/get_auction_data`：复用 snapshot 字段语义

验收点：

- 策略不改/少改即可编译（通过 `IMarketDataApi`）

### Step 3：main.cpp 替换行情来源

- 删除生成订阅 CSV 的逻辑（避免与 gateway 不一致）
- `market = ShmMarketDataApi`，读取 `market_shm` 配置并 connect

验收点：

- trade_app 启动时不会触发任何 TDF 连接/订阅日志

### Step 4：策略/模块对“行情不可用”的处理收口

统一约束：

- 当 `market` 不可用（heartbeat 超时或 md_status 非 OK）：
  - 任何下单路径必须被阻断（避免“盲下单”）

建议落点（框架层，不改业务细节）：

- `TradingMarketApi` 或模块层增加 `if (!ctx.market->is_connected())` 的 guard
- 或在 `QueuedTradingApi` 入队前增加 guard（更强约束）

### Step 5：构建依赖收口

- CMake 去掉 `TdfMarketDataApi` 源码与 `TDFAPI30` 链接

验收点：

- 部署到只安装交易 SDK 的机器也能运行（行情依赖由 gateway 提供）

---

## 9. 风险点与缓解

1) **symbol_id 映射不一致（最高风险）**  
缓解：强制配置 `symbol_csv_path`，并要求与 gateway 完全一致；gateway 重启时强制重建映射。

2) **gateway 未启动或 shm 不存在**  
缓解：trade 启动等待/重试 + 超时退出；由 supervisor 确保顺序。

3) **payload 解码与字段语义不一致（价格倍率/turnover 单位）**  
缓解：以 `gate_result/marketdata_payload.h` 为唯一真相；设计中写明 `x10000`。

4) **SeqLock + 非原子 payload 的严格 C++ data race 争议**  
缓解：工程上接受该取舍；若未来需要“严格无争议”，升级为 entry 双缓冲（由 gateway/IPC 统一升级）。

---

## 10. 验收标准（上线前 checklist）

- trade_app 不再链接/加载/登录 TDF（无行情账号依赖）
- gateway 运行时：
  - trade_app 能读取关注 symbol 的快照，策略正常运行
- gateway 掉线或 `md_status!=OK`：
  - trade_app 进入降级（禁止新下单），并持续监控恢复
- gateway 重启：
  - trade_app 能检测 epoch 变化并自动重同步（不使用旧映射/旧 shm）
- 多个 trade_app 并发运行：
  - 同时读取同一 shm 不互相影响（只读）

